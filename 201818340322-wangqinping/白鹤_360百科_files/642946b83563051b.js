!function(){function t(t){if(this.options=$.extend({},a,t),this.options.enable){if(!this.options.$dom||!this.options.$dom.length)throw"$dom \u662f\u5fc5\u8981\u5b57\u6bb5\uff0c\u8bf7\u63d0\u4f9b\u5e7f\u544a\u5bf9\u5e94\u7684$dom!";$(window).off("scroll"+this.options.scrollNamespace),this.isMobel=/micromessenger|android|iphone|webos|iPod|BlackBerry/i.test(navigator.userAgent),this.adsData=this.adsDataClone=[],this.impurl=null,this.adstk=[],this._init()}}if(!window.$)throw"\u6b64sdk\u4f9d\u8d56\u4e8ejquery\u6216zepto, \u8bf7\u52a0\u8f7d\u540e\u518d\u4f7f\u7528!";var o={getUid:function(){function t(t){var o,i=1,a=0;if(t)for(i=0,o=t.length-1;o>=0;o--)a=t.charCodeAt(o),i=(i<<6&268435455)+a+(a<<14),a=266338304&i,i=0!=a?i^a>>21:i;return i}return(""+t(window.location.href)+t(document.domain)+(new Date-0)+Math.floor(1e3*Math.random())).substr(0,32)},imageSendLog:function(){return window.recomm_img_log={},function(t){var o="log_"+ +new Date,i=window.recomm_img_log[o]=new Image;i.onload=i.onerror=function(){window.recomm_img_log&&window.recomm_img_log[o]&&(window.recomm_img_log[o]=null,delete window.recomm_img_log[o])},i.src=t}}(),getXYAxis:function(t,o){var i=$(t.target),a=i.closest(o);return a.length||(a=i.parent()),[Math.abs(parseInt(i.offset().left-a.offset().left+t.offsetX)),Math.abs(parseInt(i.offset().top-a.offset().top+t.offsetY))]},isVisible:function(t,o){if(t&&t.getBoundingClientRect){var i=$(window).width(),a=$(window).height(),n=t.getBoundingClientRect();return!(!(n&&n.top>=0&&n.top+o<=a||n.bottom-o>=0&&n.bottom<=a||n.top<=0&&n.bottom>=a)||!(n.left>=0&&n.left+o<=i||n.right-o>=0&&n.right<=i||n.left<=0&&n.right>=i))}}},i=o.getUid(),a={apiUrl:{http:"http://show.3.mediav.com/s",https:"https://show-3.mediav.com/s?scheme=https"},apiParams:{type:1,of:4,newf:1,impct:2,uid:i,queryword:""},enable:!0,scrollNamespace:".haosou.mediav",partPixel:20,successCallback:function(){},noDataCallback:function(){},errorCallback:function(){},completeCallback:function(){},imptkShowCallback:function(){}};$.extend(t.prototype,{_init:function(){if(this.options.params&&this.options.params.showid)this.protocol=this.options.protocol||location.protocol.replace(/:/,""),this.options.apiParams=$.extend({},this.options.apiParams,this.options.params),this._getInitData();else{if(!this.options.adsData)throw"\u4e0d\u63d0\u4f9bshowid\u7684\u65f6\u5019\uff0c\u9700\u8981\u63d0\u4f9b\u5e7f\u544a\u6570\u636e\uff01";this.impurl=this.options.adsData.impurl,this._replaceAndMonitor(this.options.adsData),this.options.successCallback(this.options.adsData),this._bindEvents(),this._bindImpkEvents()}},_getData:function(t){var o=this;return $.ajax({url:o.options.apiUrl[o.protocol],data:o.options.apiParams,dataType:"jsonp",jsonp:"jsonp",timeout:5e3,success:function(i){i&&i.ads&&i.ads.length?(t&&t(i),i.adstk&&i.adstk.length&&o.adstk.push({hasShow:!1,data:i.adstk}),o.options.apiParams.reqtimes&&$.isNumeric(o.options.apiParams.reqtimes)&&o.options.apiParams.reqtimes++):o.options.noDataCallback()},error:function(t){o.options.errorCallback(t)},complete:function(){o.options.completeCallback()}})},_getInitData:function(){var t=this;t._getData(function(o){t.impurl=o.impurl,t._replaceAndMonitor(o),t.options.successCallback(o),t._bindEvents(),t._bindImpkEvents()})},getMoreData:function(t){var o=this;return o._getData(function(i){i&&i.ads&&i.ads.length&&(o._replaceAndMonitor(i),t&&t(i))})},_replaceAndMonitor:function(t){t&&t.ads&&t.ads.length&&(this.adsData=this.adsData.concat(t.ads),this.adsDataClone.length?this.adsDataClone=this.adsDataClone.concat(t.ads):$.extend(!0,this.adsDataClone,t.ads))},_bindEvents:function(){var t,i,a,n,e,s,r=this,l=0,d=[],p=[],c=[],h=r.isMobel?"touchstart":"mousedown",m=r.isMobel?"touchend":"mouseup";r.options.$dom.on(h,"a",function(o){t=+new Date}),r.options.$dom.on(m,"a",function(){i=+new Date}),r.options.$dom.on("click","a",function(h){if($(this).closest(r.options.itemWrap).length&&(l=$(this).data("index"))!=undefined&&r.adsData[l]&&(d=r.adsData[l].clktk,p=r.adsDataClone[l].clktk,d&&d.length)){a=o.getXYAxis(h,r.options.itemWrap),n=a[0],e=a[1];for(var m=0;m<d.length;m++)d[m]=p[m].replace(/__EVENT_TIME_START__/g,t).replace(/__OFFSET_X__/g,n).replace(/__OFFSET_Y__/g,e).replace(/__EVENT_TIME_END__/g,i);c=r.adsDataClone[l].assets;var u=$(this).index();s=c&&c.length&&c[u]&&"img"===$(this).data("type")?c[u].curl:r.adsDataClone[l].curl,s=s.replace(/__EVENT_TIME_START__/g,t).replace(/__OFFSET_X__/g,n).replace(/__OFFSET_Y__/g,e).replace(/__EVENT_TIME_END__/g,i),$(this).attr("href",s),r._mvClick(l)}}),r.options.delElem&&r.options.$dom.on("click",r.options.delElem,function(){var t=$(this).closest(r.options.itemWrap),o=t.find("a"),i=o.data("index");t.length&&t.remove(),i&&(r.adsData[i]=r.adsDataClone[i]={})})},_bindImpkEvents:function(){var t=this,o=null;clearTimeout(o),o=setTimeout(function(){var o=t.options.$dom.find(t.options.itemWrap);if(o&&o.length&&t._imptkMonitor(),o&&o.length){var i=null;$(window).on("scroll"+t.options.scrollNamespace,function(){clearTimeout(i),i=setTimeout(function(){t._imptkMonitor()},100)});var a=null;$(window).on("resize"+t.options.scrollNamespace,function(){clearTimeout(a),a=setTimeout(function(){t._imptkMonitor()},100)})}},100)},_imptkMonitor:function(){var t=this;$.each(t.options.$dom.find(t.options.itemWrap),function(i,a){var n=$(a);!n.data("mediavImptked")&&o.isVisible(a,t.options.partPixel)&&(t.mvShow(n.find("a").data("index")),n.data("mediavImptked",1))})},_mvClick:function(t){for(var i=this.adsData[t]&&this.adsData[t].clktk||[],a=0;a<i.length;a++)o.imageSendLog(i[a])},mvShow:function(t){if(t!==undefined){var i=this.impurl,a=this.adsData[t];a&&a.imptk&&this._impkShow(a,i);var n=Math.floor(t/this.options.apiParams.impct),e=this.adstk[n];if(e&&!e.hasShow&&e.data){for(var s=0;s<e.data.length;s++)o.imageSendLog(e.data[s]);e.hasShow=!0}}},_impkShow:function(t,i){var a=t.imptk||[];if(a.length){for(var n=0;n<a.length;n++)o.imageSendLog(a[n]);var e=t.imparg;i&&e&&o.imageSendLog(i+e),this.options.imptkShowCallback()}}}),window.MediavAds=t}();